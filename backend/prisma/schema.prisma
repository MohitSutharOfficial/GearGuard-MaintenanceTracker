// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  fullName      String   @map("full_name")
  role          Role
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  createdRequests     MaintenanceRequest[] @relation("CreatedBy")
  assignedRequests    MaintenanceRequest[] @relation("AssignedTo")
  teamMemberships     TeamMember[]
  auditLogs           AuditLog[]
  
  @@map("users")
}

model Equipment {
  id                  String   @id @default(uuid())
  name                String
  serialNumber        String   @unique @map("serial_number")
  category            String
  department          String
  employee            String?
  purchaseDate        DateTime? @map("purchase_date")
  warrantyExpiry      DateTime? @map("warranty_expiry")
  location            String
  status              EquipmentStatus @default(ACTIVE)
  maintenanceTeamId   String?  @map("maintenance_team_id")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  // Relations
  maintenanceTeam     MaintenanceTeam? @relation(fields: [maintenanceTeamId], references: [id])
  maintenanceRequests MaintenanceRequest[]
  
  @@index([maintenanceTeamId])
  @@index([status])
  @@map("equipment")
}

model MaintenanceRequest {
  id                  String   @id @default(uuid())
  subject             String
  type                RequestType
  equipmentId         String   @map("equipment_id")
  maintenanceTeamId   String?  @map("maintenance_team_id")
  stage               RequestStage @default(NEW)
  priority            Priority @default(MEDIUM)
  scheduledDate       DateTime? @map("scheduled_date")
  duration            Float?
  hoursSpent          Float    @default(0) @map("hours_spent")
  description         String   @db.Text
  notes               String?  @db.Text
  technicianId        String?  @map("technician_id")
  createdBy           String   @map("created_by")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  completedAt         DateTime? @map("completed_at")
  
  // Relations
  equipment           Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  maintenanceTeam     MaintenanceTeam? @relation(fields: [maintenanceTeamId], references: [id])
  technician          User?    @relation("AssignedTo", fields: [technicianId], references: [id])
  creator             User     @relation("CreatedBy", fields: [createdBy], references: [id])
  
  @@index([equipmentId])
  @@index([maintenanceTeamId])
  @@index([stage])
  @@index([type])
  @@index([technicianId])
  @@index([scheduledDate])
  @@map("maintenance_requests")
}

model MaintenanceTeam {
  id              String   @id @default(uuid())
  name            String
  specialization  String?
  description     String?  @db.Text
  color           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // Relations
  equipment           Equipment[]
  maintenanceRequests MaintenanceRequest[]
  members             TeamMember[]
  
  @@map("maintenance_teams")
}

model TeamMember {
  id        String   @id @default(uuid())
  teamId    String   @map("team_id")
  userId    String   @map("user_id")
  role      TeamRole @default(MEMBER)
  joinedAt  DateTime @default(now()) @map("joined_at")
  
  // Relations
  team      MaintenanceTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([teamId, userId])
  @@map("team_members")
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?  @map("user_id")
  action      String
  entityType  String   @map("entity_type")
  entityId    String   @map("entity_id")
  oldValues   Json?    @map("old_values")
  newValues   Json?    @map("new_values")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at")
  
  // Relations
  user        User?    @relation(fields: [userId], references: [id])
  
  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

enum Role {
  ADMIN
  MANAGER
  TECHNICIAN
}

enum EquipmentStatus {
  ACTIVE
  UNDER_REPAIR
  SCRAPPED
}

enum RequestType {
  CORRECTIVE
  PREVENTIVE
}

enum RequestStage {
  NEW
  IN_PROGRESS
  REPAIRED
  SCRAP
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TeamRole {
  LEAD
  MEMBER
}
